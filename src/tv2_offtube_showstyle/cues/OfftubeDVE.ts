import {
	IBlueprintActionManifest,
	IBlueprintPiece,
	ISegmentUserContext,
	PieceLifespan,
	SplitsContent
} from '@tv2media/blueprints-integration'
import {
	ActionSelectDVE,
	AddParentClass,
	CalculateTime,
	CueDefinitionDVE,
	DVEPieceMetaData,
	generateExternalId,
	GetDVETemplate,
	GetTagForDVE,
	GetTagForDVENext,
	literal,
	PartDefinition,
	t,
	TemplateIsValid
} from 'tv2-common'
import { AdlibActionType, AdlibTags, SharedOutputLayers, TallyTags } from 'tv2-constants'
import { OfftubeMakeContentDVE } from '../content/OfftubeDVEContent'
import { OfftubeShowstyleBlueprintConfig } from '../helpers/config'
import { OfftubeOutputLayers, OfftubeSourceLayer } from '../layers'

export function OfftubeEvaluateDVE(
	context: ISegmentUserContext,
	config: OfftubeShowstyleBlueprintConfig,
	pieces: IBlueprintPiece[],
	actions: IBlueprintActionManifest[],
	partDefinition: PartDefinition,
	parsedCue: CueDefinitionDVE,
	adlib?: boolean,
	rank?: number
) {
	if (!parsedCue.template) {
		return
	}

	const rawTemplate = GetDVETemplate(config.showStyle.DVEStyles, parsedCue.template)
	if (!rawTemplate) {
		context.notifyUserWarning(`Could not find template ${parsedCue.template}`)
		return
	}

	if (!TemplateIsValid(rawTemplate.DVEJSON)) {
		context.notifyUserWarning(`Invalid DVE template ${parsedCue.template}`)
		return
	}

	const adlibContent = OfftubeMakeContentDVE(
		context,
		config,
		partDefinition,
		parsedCue,
		rawTemplate,
		AddParentClass(config, partDefinition),
		true
	)

	const pieceContent = OfftubeMakeContentDVE(
		context,
		config,
		partDefinition,
		parsedCue,
		rawTemplate,
		AddParentClass(config, partDefinition),
		false
	)

	if (adlibContent.valid && pieceContent.valid) {
		let start = parsedCue.start ? CalculateTime(parsedCue.start) : 0
		start = start ? start : 0
		const end = parsedCue.end ? CalculateTime(parsedCue.end) : undefined
		pieces.push({
			externalId: partDefinition.externalId,
			name: parsedCue.template,
			enable: {
				start,
				...(end ? { duration: end - start } : {})
			},
			outputLayerId: SharedOutputLayers.PGM,
			sourceLayerId: OfftubeSourceLayer.PgmDVE,
			lifespan: PieceLifespan.WithinPart,
			toBeQueued: true,
			content: {
				...pieceContent.content,
				timelineObjects: [...pieceContent.content.timelineObjects]
			},
			prerollDuration: Number(config.studio.CasparPrerollDuration) || 0,
			metaData: literal<DVEPieceMetaData>({
				mediaPlayerSessions: [partDefinition.segmentExternalId],
				sources: parsedCue.sources,
				config: rawTemplate,
				userData: {
					type: AdlibActionType.SELECT_DVE,
					config: parsedCue,
					name: parsedCue.template,
					videoId: partDefinition.fields.videoId,
					segmentExternalId: partDefinition.segmentExternalId
				},
				sisyfosPersistMetaData: {
					sisyfosLayers: []
				}
			}),
			tags: [
				GetTagForDVE(partDefinition.segmentExternalId, parsedCue.template, parsedCue.sources),
				GetTagForDVENext(partDefinition.segmentExternalId, parsedCue.template, parsedCue.sources),
				TallyTags.DVE_IS_LIVE
			]
		})

		const userData: ActionSelectDVE = {
			type: AdlibActionType.SELECT_DVE,
			config: parsedCue,
			name: `DVE: ${parsedCue.template}`,
			videoId: partDefinition.fields.videoId,
			segmentExternalId: partDefinition.segmentExternalId
		}
		actions.push({
			externalId: generateExternalId(context, userData),
			actionId: AdlibActionType.SELECT_DVE,
			userData,
			userDataManifest: {},
			display: {
				_rank: rank,
				sourceLayerId: OfftubeSourceLayer.PgmDVE,
				outputLayerId: OfftubeOutputLayers.PGM,
				label: t(`${partDefinition.storyName}`),
				tags: [AdlibTags.ADLIB_KOMMENTATOR, ...(adlib ? [AdlibTags.ADLIB_FLOW_PRODUCER] : [])],
				content: literal<SplitsContent>({
					...pieceContent.content
				}),
				currentPieceTags: [GetTagForDVE(partDefinition.segmentExternalId, parsedCue.template, parsedCue.sources)],
				nextPieceTags: [GetTagForDVENext(partDefinition.segmentExternalId, parsedCue.template, parsedCue.sources)]
			}
		})
	}
}
